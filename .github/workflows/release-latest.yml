# Build and push Docker image when new pgcli is available.
# Runs weekly and can be triggered manually.
name: Release latest pgcli

on:
  schedule:
    - cron: '0 8 * * 1'  # Mondays 08:00 UTC
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # commit updated requirements
      packages: write  # push to ghcr.io
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch latest pgcli version
        id: latest
        run: |
          latest=$(curl -s https://pypi.org/pypi/pgcli/json | python3 -c "import sys,json; print(json.load(sys.stdin)['info']['version'])")
          echo "version=$latest" >> $GITHUB_OUTPUT
          echo "Latest pgcli: $latest"

      - name: Check if update needed
        id: check
        run: |
          current=$(grep -E '^pgcli==' requirements.in | sed 's/pgcli==//')
          echo "Current: $current"
          if [[ "${{ steps.latest.outputs.version }}" == "$current" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Already at latest ($current). Nothing to do."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Update requirements.in
        if: steps.check.outputs.skip != 'true'
        run: |
          sed -i "s/^pgcli==.*/pgcli==${{ steps.latest.outputs.version }}/" requirements.in
          cat requirements.in

      - name: Regenerate lockfile
        if: steps.check.outputs.skip != 'true'
        run: make update

      - name: Build, push, and tag latest
        if: steps.check.outputs.skip != 'true'
        env:
          IMAGE: ghcr.io/${{ github.repository }}
          VERSION: ${{ steps.latest.outputs.version }}
        run: make release

      - name: Create git tag and commit (optional)
        if: steps.check.outputs.skip != 'true' && github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add requirements.in requirements.lock
          git diff --staged --quiet || git commit -m "Bump pgcli to ${{ steps.latest.outputs.version }}"
          git push origin main || true
